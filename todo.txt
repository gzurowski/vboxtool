Todo:

- preconfigured portforwarding
  - settings can be set in savestate, not while running
  - only for host ports > 1024 (nat restriction)
  - write settings:
    VBoxManage setextradata "Ubuntu JeOS" "VBoxInternal/Devices/pcnet/0/LUN#0/Config/tcp-2022-22/Protocol" TCP
    VBoxManage setextradata "Ubuntu JeOS" "VBoxInternal/Devices/pcnet/0/LUN#0/Config/tcp-2022-22/HostPort" 2022
    VBoxManage setextradata "Ubuntu JeOS" "VBoxInternal/Devices/pcnet/0/LUN#0/Config/tcp-2022-22/GuestPort" 22
    - 'tcp-2022-22' is arbitrary
  - read settings:
    VBoxManage getextradata "Ubuntu JeOS" enumerate | grep "VBoxInternal/Devices"
  - reset settings:
    VBoxManage setextradata "Ubuntu JeOS" "VBoxInternal/Devices/pcnet/0/LUN#0/Config/tcp-2022-22/Protocol" 
    VBoxManage setextradata "Ubuntu JeOS" "VBoxInternal/Devices/pcnet/0/LUN#0/Config/tcp-2022-22/HostPort" 
    VBoxManage setextradata "Ubuntu JeOS" "VBoxInternal/Devices/pcnet/0/LUN#0/Config/tcp-2022-22/GuestPort"
  - config file format: 
    <session name>,<vrdp port>,[<host port>-<guest port>|...] -> Ubuntu JeOS,3393,2022-22|80-80
- vbox backup, second approach: incremental backup
  - basic procedure 'vbox backup' 
    - save session 'savestate'
    - create a snapshot, name=vbox-backup
      VBoxManage snapshot "Ubuntu JeOS" take "vbox-backup"
      - only when there is none, 
    - copy all files
      - first time is taking long because the base-vdi is also copied
      - the next time, the bases-vdi will not change, this imoproves speed dramatically
      - rsync, op basis van datum
    - restart session: 'startvm'
  - periodic cleaning = vbox cleanbackup
    - is needed because the savestate-file (.vdi in the snapshot-map) increases
    - procedure:
      - save session sessie 'savestate'
        - merge (discard) snapshot 
          - maar niet de state!
            VBoxManage snapshot "Ubuntu JeOS" discard "vbox-backup"
          - the snaphot (.sav) will be merged with the base-vdi
        - run the basic-backup procedure (see above)
          - in there, a (new) snapshot is made
          - copy files is slow because the base-vdihas been changed
        - autorun cleanbackup based on:
          - absolute filesize of snapshot-vdi (1 GB?)
          - relative filesize of snapshot-vdi compared base-vdi to (10%)              
    - summary:
      - vbox backup
        - incremental backup
        - procedure 'vbox backupclean' is run automatic within the base-backup
          - based on filesize (absolute/relative) of the snapshot-vdi
      - vbox cleanbackup
        - is the same as 'vbox backup' but with a forced merge
     - /etc/vbox/vbox.conf
       - backupdir=...... # Default: <vbox-homedir>/.backup
       - backupthreshold=......  # Default: 1 GB
  - optimalisation: first restart and then copy
    - is possible because the base- and the snapshot-vdi are readonly
    - exclude last snapshot vdi (this is runtime modified)
    - question if this is needed (rsync time is limited due to local copy) 
- vbox backup, third approach: online backup
  - procedure
    - create snapshot in runtime (thus without saving)
      - session is automatically paused by VirtualBox
    - copy all files 
      - base- and the snapshot-vdi are readonly
      - exclude last snapshot vdi (this is runtime modified)
  - problem(s):
    - the length of the vdi-chain increases each time a new snapshot is created
- implement 'metrics' command
  - is a substitute for the derived values of cpu and mem from 'top'
  - then, the script becomes 2.0.x only!
- munin plugin
  - monitor sessions health (cpu/memory) historical and graphically
  - threshold warning (mail) on exceeded cpu/memory
  - summarize resource occupation
  - based on the new metrics command, run periodically by cron
- webserver
  - run portions of the vbox script:
    - monitor (show), start, save, stop, backup
  - based on python

Tasks:
- test:
  - restore backup
- auto-start vbox-sessions on host-boot: http://forums.virtualbox.org/viewtopic.php?t=6663
- auto-stop when host goes down
  - see /etc/init.d/vboxdrv, function stop_vms (called in 'stop'-section)
  - must be configured
    - seems to works with one session only
    - when there are more than one session, sessions goes into 'aborted' state
    - investigate
 
